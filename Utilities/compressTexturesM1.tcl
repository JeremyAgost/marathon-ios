set Vision(0)  "1 1 1 0"
set Vision(1)  "1 1 0 1"
set Vision(2)  "1 1 1 0"
set Vision(3)  "1 1 1 0"
set Vision(4)  "1 1 0 1"
set Vision(5)  "1 1 1 0"
set Vision(6)  "1 1 1 0"
set Vision(7)  "0 1 0 1"
set Vision(8)  "1 1 1 0"
set Vision(9)  "1 0 0 1"
set Vision(10)  "1 1 1 0"
set Vision(11)  "1 1 1 0"
set Vision(12)  "1 1 0 1"
set Vision(13)  "1 1 0 1"
set Vision(14)  "1 1 1 0"
set Vision(15)  "1 1 1 0"
set Vision(16)  "0 0 1 1"
set Vision(17)  "1 1 1 0"
set Vision(18)  "1 1 1 0"
# NB: Too dark!
set Vision(19)  "0 0 2 1"
set Vision(20)  "1 1 1 0"
set Vision(21)  "1 1 1 0"
set Vision(22)  "1 1 1 0"
set Vision(23)  "1 1 1 0"
set Vision(24)  "0 0 1 1"
set Vision(25)  "1 1 1 0"
set Vision(26)  "1 1 1 0"
set Vision(27)  "1 1 1 0"
set Vision(28)  "1 1 1 0"
set Vision(29)  "1 1 1 0"
set Vision(30)  "0 0 1 1"
set Vision(31)  "1 1 1 0"

set Opacity(17,19,Type) 1
set Opacity(17,19,Scale) 0.6
set Opacity(18,12,Type) 1
set Opacity(18,12,Scale) 0.6

lappend Collections(/general/controlpanels01.dds) "17 0"
lappend Collections(/general/controlpanels01.dds) "18 0"
lappend Collections(/general/controlpanels01.dds) "19 0"
lappend Collections(/general/controlpanels02.dds) "17 48"
lappend Collections(/general/controlpanels02.dds) "18 38"
lappend Collections(/general/controlpanels02.dds) "19 44"
lappend Collections(/general/controlpanels03.dds) "17 49"
lappend Collections(/general/controlpanels03.dds) "18 39"
lappend Collections(/general/controlpanels03.dds) "19 45"
lappend Collections(/general/controlpanels04.dds) "17 1"
lappend Collections(/general/controlpanels04.dds) "18 1"
lappend Collections(/general/controlpanels04.dds) "19 1"
lappend Collections(/general/herringbone.dds) "17 12"
lappend Collections(/general/herringbone.dds) "18 13"
lappend Collections(/general/herringbone.dds) "19 12"
lappend Collections(/general/rechargers01.dds) "17 2"
lappend Collections(/general/rechargers01.dds) "18 2"
lappend Collections(/general/rechargers01.dds) "19 2"
lappend Collections(/general/rechargers02.dds) "17 44"
lappend Collections(/general/rechargers02.dds) "18 40"
lappend Collections(/general/rechargers02.dds) "19 46"
lappend Collections(/general/rechargers03.dds) "17 45"
lappend Collections(/general/rechargers03.dds) "18 41"
lappend Collections(/general/rechargers03.dds) "19 47"
lappend Collections(/general/rechargers04.dds) "17 46"
lappend Collections(/general/rechargers04.dds) "18 42"
lappend Collections(/general/rechargers04.dds) "19 48"
lappend Collections(/general/rechargers05.dds) "17 47"
lappend Collections(/general/rechargers05.dds) "18 43"
lappend Collections(/general/rechargers05.dds) "19 49"
lappend Collections(/general/rechargers06.dds) "17 3"
lappend Collections(/general/rechargers06.dds) "18 3"
lappend Collections(/general/rechargers06.dds) "19 3"
lappend Collections(/general/special01.dds) "17 37"
lappend Collections(/general/special01.dds) "18 36"
lappend Collections(/general/special02.dds) "17 50"
lappend Collections(/general/special02.dds) "18 49"
lappend Collections(/general/special03.dds) "17 38"
lappend Collections(/general/special03.dds) "18 37"
lappend Collections(/general/starscape.dds) "30 0"
lappend Collections(/general/stripes.dds) "17 5"
lappend Collections(/general/stripes.dds) "18 34"
lappend Collections(/general/teleporter.dds) "17 36"
lappend Collections(/general/teleporter.dds) "18 35"
lappend Collections(/general/teleporter.dds) "19 35"
lappend Collections(/general/terminal01.dds) "17 4"
lappend Collections(/general/terminal01.dds) "18 4"
lappend Collections(/general/terminal01.dds) "19 4"
lappend Collections(/general/terminal01.dds) "19 57"
lappend Collections(/general/terminal02.dds) "17 39"
lappend Collections(/general/terminal02.dds) "18 44"
lappend Collections(/general/terminal02.dds) "19 50"
lappend Collections(/general/terminal02.dds) "19 58"
lappend Collections(/general/terminal03.dds) "17 40"
lappend Collections(/general/terminal03.dds) "18 45"
lappend Collections(/general/terminal03.dds) "19 51"
lappend Collections(/general/terminal03.dds) "19 59"
lappend Collections(/general/terminal04.dds) "17 41"
lappend Collections(/general/terminal04.dds) "18 46"
lappend Collections(/general/terminal04.dds) "19 52"
lappend Collections(/general/terminal04.dds) "19 60"
lappend Collections(/general/terminal05.dds) "17 42"
lappend Collections(/general/terminal05.dds) "18 47"
lappend Collections(/general/terminal05.dds) "19 53"
lappend Collections(/general/terminal05.dds) "19 61"
lappend Collections(/general/terminal06.dds) "17 43"
lappend Collections(/general/terminal06.dds) "18 48"
lappend Collections(/general/terminal06.dds) "19 54"
lappend Collections(/general/terminal06.dds) "19 62"
lappend Collections(/grendel/grendel11.dds) "22 11"
lappend Collections(/grendel/grendel12.dds) "22 12"
lappend Collections(/grendel/grendel13.dds) "22 13"
lappend Collections(/grendel/grendel51.dds) "17 51"
lappend Collections(/grendel/grendel52.dds) "17 52"
lappend Collections(/grendel/grendel53.dds) "17 53"
lappend Collections(/grendel/grendel54.dds) "17 54"
lappend Collections(/grendel/grendel55.dds) "17 55"
lappend Collections(/grendel/grendel56.dds) "17 56"
lappend Collections(/grendel/grendel57.dds) "17 57"
lappend Collections(/grendel/grendel58.dds) "17 58"
lappend Collections(/grendel/grendel59.dds) "17 59"
lappend Collections(/grendel/grendel60.dds) "17 60"
lappend Collections(/grendel/grendel_night.dds) "28 0"
lappend Collections(/grendel/grendel_noon.dds) "27 0"
lappend Collections(/lava/lava05.dds) "18 5"
lappend Collections(/lava/lava06.dds) "18 6"
lappend Collections(/lava/lava07.dds) "18 7"
lappend Collections(/lava/lava08.dds) "18 8"
lappend Collections(/lava/lava09.dds) "18 9"
lappend Collections(/lava/lava10.dds) "18 10"
lappend Collections(/lava/lava11.dds) "18 11"
lappend Collections(/lava/lava12.dds) "18 12"
lappend Collections(/lava/lava14.dds) "18 14"
lappend Collections(/lava/lava15.dds) "18 15"
lappend Collections(/lava/lava16.dds) "18 16"
lappend Collections(/lava/lava17.dds) "18 17"
lappend Collections(/lava/lava18.dds) "18 18"
lappend Collections(/lava/lava19.dds) "18 19"
lappend Collections(/lava/lava20.dds) "18 20"
lappend Collections(/lava/lava21.dds) "18 21"
lappend Collections(/lava/lava22.dds) "18 22"
lappend Collections(/lava/lava23.dds) "18 23"
lappend Collections(/lava/lava24.dds) "18 24"
lappend Collections(/lava/lava25.dds) "18 25"
lappend Collections(/lava/lava26.dds) "18 26"
lappend Collections(/lava/lava27.dds) "18 27"
lappend Collections(/lava/lava28.dds) "18 28"
lappend Collections(/lava/lava29.dds) "18 29"
lappend Collections(/lava/lava30.dds) "18 30"
lappend Collections(/lava/lava31.dds) "18 31"
lappend Collections(/lava/lava32.dds) "18 32"
lappend Collections(/lava/lava33.dds) "18 33"
lappend Collections(/pfhor/pfhor00.dds) "21 0"
lappend Collections(/pfhor/pfhor01.dds) "21 1"
lappend Collections(/pfhor/pfhor02.dds) "21 2"
lappend Collections(/pfhor/pfhor03.dds) "21 3"
lappend Collections(/pfhor/pfhor04.dds) "21 4"
lappend Collections(/pfhor/pfhor05.dds) "21 5"
lappend Collections(/pfhor/pfhor06.dds) "21 6"
lappend Collections(/pfhor/pfhor07.dds) "21 7"
lappend Collections(/pfhor/pfhor08.dds) "21 8"
lappend Collections(/pfhor/pfhor09.dds) "21 9"
lappend Collections(/pfhor/pfhor11.dds) "21 11"
lappend Collections(/pfhor/pfhor12.dds) "21 12"
lappend Collections(/pfhor/pfhor13.dds) "21 13"
lappend Collections(/pfhor/pfhor14.dds) "21 14"
lappend Collections(/pfhor/pfhor15.dds) "21 15"
lappend Collections(/pfhor/pfhor16.dds) "21 16"
lappend Collections(/pfhor/pfhor17.dds) "21 17"
lappend Collections(/pfhor/pfhor18.dds) "21 18"
lappend Collections(/pfhor/pfhor19.dds) "21 19"
lappend Collections(/pfhor/pfhor20.dds) "21 20"
lappend Collections(/pfhor/pfhor21.dds) "21 21"
lappend Collections(/pfhor/pfhor22.dds) "21 22"
lappend Collections(/pfhor/pfhor23.dds) "21 23"
lappend Collections(/pfhor/pfhor24.dds) "21 24"
lappend Collections(/pfhor/pfhor25.dds) "21 25"
lappend Collections(/pfhor/pfhor26.dds) "21 26"
lappend Collections(/pfhor/pfhor27.dds) "21 27"
lappend Collections(/pfhor/pfhor28.dds) "21 28"
lappend Collections(/pfhor/pfhor29.dds) "21 29"
lappend Collections(/pfhor/pfhor30.dds) "21 30"
lappend Collections(/pfhor/pfhor31.dds) "21 31"
lappend Collections(/pfhor/pfhor32.dds) "21 32"
lappend Collections(/pfhor/pfhor33.dds) "21 33"
lappend Collections(/pfhor/pfhor34.dds) "21 34"
lappend Collections(/pfhor/pfhor35.dds) "21 35"
lappend Collections(/pfhor/pfhor36.dds) "21 36"
lappend Collections(/pfhor/pfhor36.dds) "21 50"
lappend Collections(/pfhor/pfhor37.dds) "21 37"
lappend Collections(/pfhor/pfhor38.dds) "21 38"
lappend Collections(/pfhor/pfhor39.dds) "21 39"
lappend Collections(/pfhor/pfhor40.dds) "21 40"
lappend Collections(/pfhor/pfhor41.dds) "21 41"
lappend Collections(/pfhor/pfhor42.dds) "21 42"
lappend Collections(/pfhor/pfhor43.dds) "21 43"
lappend Collections(/pfhor/pfhor44.dds) "21 44"
lappend Collections(/pfhor/pfhor45.dds) "21 45"
lappend Collections(/pfhor/pfhor46.dds) "21 46"
lappend Collections(/pfhor/pfhor47.dds) "21 47"
lappend Collections(/pfhor/pfhor48.dds) "21 48"
lappend Collections(/pfhor/pfhor49.dds) "21 49"
lappend Collections(/pid/pid37.dds) "19 37"
lappend Collections(/pid/pid37.dds) "19 56"
lappend Collections(/pid/pid38.dds) "19 38"
lappend Collections(/pid/pid39.dds) "19 39"
lappend Collections(/pid/pid40.dds) "19 40"
lappend Collections(/pid/pid41.dds) "19 41"
lappend Collections(/pid/pid63.dds) "19 63"
lappend Collections(/sewage/sewage05.dds) "19 5"
lappend Collections(/sewage/sewage06.dds) "19 6"
lappend Collections(/sewage/sewage07.dds) "19 7"
lappend Collections(/sewage/sewage08.dds) "19 8"
lappend Collections(/sewage/sewage09.dds) "19 9"
lappend Collections(/sewage/sewage10.dds) "19 10"
lappend Collections(/sewage/sewage11.dds) "19 11"
lappend Collections(/sewage/sewage14.dds) "19 14"
lappend Collections(/sewage/sewage15.dds) "19 15"
lappend Collections(/sewage/sewage16.dds) "19 16"
lappend Collections(/sewage/sewage17.dds) "19 17"
lappend Collections(/sewage/sewage18.dds) "19 18"
lappend Collections(/sewage/sewage19.dds) "19 19"
lappend Collections(/sewage/sewage20.dds) "19 20"
lappend Collections(/sewage/sewage21.dds) "19 21"
lappend Collections(/sewage/sewage22.dds) "19 22"
lappend Collections(/sewage/sewage23.dds) "19 23"
lappend Collections(/sewage/sewage24.dds) "19 24"
lappend Collections(/sewage/sewage25.dds) "19 25"
lappend Collections(/sewage/sewage26.dds) "19 26"
lappend Collections(/sewage/sewage28.dds) "19 28"
lappend Collections(/sewage/sewage29.dds) "19 29"
lappend Collections(/sewage/sewage30.dds) "19 30"
lappend Collections(/sewage/sewage31.dds) "19 31"
lappend Collections(/sewage/sewage32.dds) "19 32"
lappend Collections(/sewage/sewage33.dds) "19 33"
lappend Collections(/sewage/sewage34.dds) "19 34"
lappend Collections(/sewage/sewage36.dds) "19 36"
lappend Collections(/sewage/sewage42.dds) "19 42"
lappend Collections(/sewage/sewage43.dds) "19 43"
lappend Collections(/sewage/sewage55.dds) "19 55"
lappend Collections(/water/water06.dds) "17 6"
lappend Collections(/water/water07.dds) "17 7"
lappend Collections(/water/water08.dds) "17 8"
lappend Collections(/water/water09.dds) "17 9"
lappend Collections(/water/water10.dds) "17 10"
lappend Collections(/water/water11.dds) "17 11"
lappend Collections(/water/water13.dds) "17 13"
lappend Collections(/water/water14.dds) "17 14"
lappend Collections(/water/water15.dds) "17 15"
lappend Collections(/water/water16.dds) "17 16"
lappend Collections(/water/water17.dds) "17 17"
lappend Collections(/water/water18.dds) "17 18"
lappend Collections(/water/water19.dds) "17 19"
lappend Collections(/water/water20.dds) "17 20"
lappend Collections(/water/water21.dds) "17 21"
lappend Collections(/water/water22.dds) "17 22"
lappend Collections(/water/water23.dds) "17 23"
lappend Collections(/water/water24.dds) "17 24"
lappend Collections(/water/water25.dds) "17 25"
lappend Collections(/water/water26.dds) "17 26"
lappend Collections(/water/water27.dds) "17 27"
lappend Collections(/water/water28.dds) "17 28"
lappend Collections(/water/water29.dds) "17 29"
lappend Collections(/water/water31.dds) "17 31"
lappend Collections(/water/water32.dds) "17 32"
lappend Collections(/water/water33.dds) "17 33"
lappend Collections(/water/water34.dds) "17 34"
lappend Collections(/water/water35.dds) "17 35"

# Special sizes
set SpecialSize "512x512!"

# Buttons
set Size(19,0,2) $SpecialSize
set Size(19,0,3) $SpecialSize
set Size(19,0,42) $SpecialSize
set Size(19,0,43) $SpecialSize
set Size(19,0,46) $SpecialSize
set Size(19,0,47) $SpecialSize
set Size(19,0,48) $SpecialSize
set Size(19,0,49) $SpecialSize
set Size(19,0,55) $SpecialSize
# Terminals
set Size(19,0,57) $SpecialSize
set Size(19,0,58) $SpecialSize
set Size(19,0,59) $SpecialSize
set Size(19,0,60) $SpecialSize
set Size(19,0,61) $SpecialSize
set Size(19,0,62) $SpecialSize


set Weighting --channel-weighting-linear
set BPP        --bits-per-pixel-4
set TextureSize "256x256!"

# Try a large size, but 2bpp
set BPP        --bits-per-pixel-2
set TextureSize "512x512!"

proc Rename {} {
  global Collections
  set TopDir [pwd]
  file mkdir TTEP-M1-Original
  cd TTEP-M1-DDS
  foreach class [glob *] {
    cd $class
    foreach file [glob *] {
      
      foreach tmp $Collections(/$class/$file) {
        set collection [lindex $tmp 0]
        set bitmap [lindex $tmp 1]
        set outputFile [file join $TopDir TTEP-M1-Original $collection 0 [format bitmap%03d.dds $bitmap]]
        puts "Copy $file $outputFile"
        file mkdir [file dir $outputFile]
        file copy -force $file $outputFile
      }
    }
    cd ..
  }
}

set TopDir [pwd]
file mkdir TTEP-M1

set fid [open TTEP-M1/TTEP-M1.mml w]
puts $fid "<marathon>"
puts $fid "<opengl>"

cd TTEP-M1-Original
foreach collection [glob *] {
  cd $collection
  set InfraVision [lindex $Vision($collection) 3]
  puts "Collection $collection : $InfraVision"
  foreach clut [glob *] {
    puts "\tCLUT: $clut"
    foreach image [lsort [glob $clut/bitmap*.dds]] {
      # Find bitmap number
      set bitmap [string range $image end-6 end-4]
      set bitmap [string trimleft $bitmap 0]
      if { $bitmap == "" } { set bitmap 0 }

      # Convert to 128x128
      puts "\t\tProcessing $image bitmap: $bitmap"
      set tail [file tail $image]
      set base [file root $tail]
      set outputFile [file join $TopDir TTEP-M1 $collection $clut $base.pvrtc]
      file mkdir [file dir $outputFile]

      set TempFile [file join $TopDir TTEP-M1-PNG $collection $clut $base.png]
      file mkdir [file dir $TempFile]

      set size [exec identify -format "%w %h" $image]
      set width [lindex $size 0]
      set height [lindex $size 1]
      if { $width > $height } {
        set maxDim $width
      } else {
        set maxDim $height
      }

      if { $width == $height } {
        set Compress 1
        set size "128x128!"
        set size $TextureSize
      } else {
        set Compress 0
        set size "${width}x$height"
      }

      # Special sizes
      if { [info exists Size($collection,$clut,$bitmap)] } {
        set size $Size($collection,$clut,$bitmap)
        puts "\t\t\tSpecial Size!: $size"
      }

      # Square, so we resize
      exec convert $image -resize $size $TempFile
      if { $Compress } {
        exec texturetool -e PVRTC -m -f PVR $Weighting $BPP -o $outputFile $TempFile
        puts $fid "<texture coll=\"$collection\" bitmap=\"$bitmap\" normal_image=\"TTEP-M1/$collection/$clut/$base.pvrtc\" clut=\"$clut\"/>"
      } else {
        set outputFile [file join $TopDir TTEP-M1 $collection $clut $base.png]
        exec convert $TempFile -resize $size $outputFile
        puts $fid "<texture coll=\"$collection\" bitmap=\"$bitmap\" normal_image=\"TTEP-M1/$collection/$clut/$base.png\" clut=\"$clut\"/>"
      }

      if { $InfraVision } {
        puts "\t\t\tCreating Vision file"
        set R [lindex $Vision($collection) 0]
        set G [lindex $Vision($collection) 1]
        set B [lindex $Vision($collection) 2]

        set VisionTempFile [file join $TopDir TTEP-M1-PNG $collection $clut $base-IR.png]
        exec convert $TempFile $TempFile -channel red -fx "(u\[1].r+u\[1].b+u\[1].g)/3.0*$R" -channel green -fx "(u\[1].r+u\[1].b+u\[1].g)/3.0*$G"  -channel blue -fx "(u\[1].r+u\[1].b+u\[1].g)/3.0*$B" $VisionTempFile
        # puts [list convert $TempFile $TempFile -channel red -fx "(u\[1].r+u\[1].b+u\[1].g)/3.0*$R" -channel green -fx "(u\[1].r+u\[1].b+u\[1].g)/3.0*$G"  -channel blue -fx "(u\[1].r+u\[1].b+u\[1].g)/3.0*$B" $VisionTempFile]

        if { $Compress } {
          set VisionFile [file join [file dir $outputFile] $base-IR.pvrtc]
          exec texturetool -e PVRTC -m -f PVR $Weighting $BPP -o $VisionFile $VisionTempFile
          # NB, clut 8 is Infravision, 9 is silhouette
          puts $fid "<texture coll=\"$collection\" bitmap=\"$bitmap\" normal_image=\"TTEP-M1/$collection/$clut/$base-IR.pvrtc\" clut=\"8\"/>"
        } else {
          # Don't compress
          set VisionFile [file join [file dir $outputFile] $base-IR.png]
          exec convert $VisionTempFile -resize $size $outputFile
          # NB, clut 8 is Infravision, 9 is silhouette
          puts $fid "<texture coll=\"$collection\" bitmap=\"$bitmap\" normal_image=\"TTEP-M1/$collection/$clut/$base-IR.png\" clut=\"8\"/>"
        }
      }
    }
  }
  cd ..
}

puts $fid "</opengl>"
puts $fid "</marathon>"
close $fid

